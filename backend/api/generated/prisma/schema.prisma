// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum identity_provider {
  GOOGLE
  MICROSOFT
  OKTA
  GITHUB
  LOCAL
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  name      String?
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // relations
  identities          Identity[]
  passwordResetTokens PasswordResetToken[]
  groupMembers        GroupMember[]
  expensesPaid        Expense[]            @relation("user_expenses_paid")
  expensesDeleted     Expense[]            @relation("user_expenses_deleted")
  expenseSplits       ExpenseSplit[]
  settlementsFrom     Settlement[]         @relation("user_settlements_from")
  settlementsTo       Settlement[]         @relation("user_settlements_to")
  preferences         UserPreferences?
  invitesSent         Invite[]             @relation("user_invites_sent")
  expenseComments     ExpenseComment[]

  @@map("user")
}

model Identity {
  id             String            @id @default(uuid()) @db.Uuid
  provider       identity_provider
  providerUserId String            @map("provider_user_id")
  passwordHash   String?           @map("password_hash")
  userId         String            @map("user_id") @db.Uuid
  createdAt      DateTime          @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId], map: "uq_identity_provider_provider_user_id")
  @@index([userId], map: "ix_identity_user_id")
  @@map("identity")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @unique @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt], map: "ix_password_reset_token_expires_at")
  @@index([userId], map: "ix_password_reset_token_user_id")
  @@map("password_reset_token")
}

model Group {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members     GroupMember[]
  expenses    Expense[]
  settlements Settlement[]
  invites     Invite[]

  @@map("group")
}

model GroupMember {
  userId   String   @map("user_id") @db.Uuid
  groupId  String   @map("group_id") @db.Uuid
  joinedAt DateTime @default(now()) @map("joined_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([userId, groupId], map: "pk_group_member_user_id_group_id")
  @@index([groupId], map: "ix_group_member_group_id")
  @@map("group_member")
}

model Expense {
  id              String    @id @default(uuid()) @db.Uuid
  groupId         String?   @map("group_id") @db.Uuid
  paidByUserId    String    @map("paid_by_user_id") @db.Uuid
  description     String
  totalAmount     Decimal   @map("total_amount")
  currency        String
  createdAt       DateTime  @default(now()) @map("created_at")
  deletedAt       DateTime? @map("deleted_at")
  deletedByUserId String?   @map("deleted_by_user_id") @db.Uuid

  group         Group? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  paidByUser    User   @relation("user_expenses_paid", fields: [paidByUserId], references: [id], onDelete: Restrict)
  deletedByUser User?  @relation("user_expenses_deleted", fields: [deletedByUserId], references: [id], onDelete: SetNull)

  splits   ExpenseSplit[]
  comments ExpenseComment[]

  @@index([groupId], map: "ix_expense_group_id")
  @@index([paidByUserId], map: "ix_expense_paid_by_user_id")
  @@index([createdAt], map: "ix_expense_created_at")
  @@map("expense")
}

model ExpenseSplit {
  id        String  @id @default(uuid()) @db.Uuid
  expenseId String  @map("expense_id") @db.Uuid
  userId    String  @map("user_id") @db.Uuid
  amount    Decimal
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([expenseId, userId], map: "uq_expense_split_expense_id_user_id")
  @@index([expenseId], map: "ix_expense_split_expense_id")
  @@index([userId], map: "ix_expense_split_user_id")
  @@map("expense_split")
}

model Settlement {
  id         String   @id @default(uuid()) @db.Uuid
  groupId    String   @map("group_id") @db.Uuid
  fromUserId String   @map("from_user_id") @db.Uuid
  toUserId   String   @map("to_user_id") @db.Uuid
  amount     Decimal
  createdAt  DateTime @default(now()) @map("created_at")

  group    Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  fromUser User  @relation("user_settlements_from", fields: [fromUserId], references: [id], onDelete: Restrict)
  toUser   User  @relation("user_settlements_to", fields: [toUserId], references: [id], onDelete: Restrict)

  @@index([groupId], map: "ix_settlement_group_id")
  @@index([fromUserId], map: "ix_settlement_from_user_id")
  @@index([toUserId], map: "ix_settlement_to_user_id")
  @@map("settlement")
}

model UserPreferences {
  userId                  String @id @map("user_id") @db.Uuid
  notificationPreferences String @map("notification_preferences") @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Invite {
  id            String    @id @default(uuid()) @db.Uuid
  inviterUserId String    @map("inviter_user_id") @db.Uuid
  invitedEmail  String    @map("invited_email")
  groupId       String    @map("group_id") @db.Uuid
  token         String    @unique
  expiresAt     DateTime  @map("expires_at")
  acceptedAt    DateTime? @map("accepted_at")

  inviterUser User  @relation("user_invites_sent", fields: [inviterUserId], references: [id], onDelete: Cascade)
  group       Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId], map: "ix_invites_group_id")
  @@index([invitedEmail], map: "ix_invites_invited_email")
  @@index([expiresAt], map: "ix_invites_expires_at")
  @@map("invites")
}

model ExpenseComment {
  id        String   @id @default(uuid()) @db.Uuid
  expenseId String   @map("expense_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expenseId], map: "ix_expense_comment_expense_id")
  @@index([createdAt], map: "ix_expense_comment_created_at")
  @@index([expenseId, createdAt], map: "ix_expense_comment_expense_id_created_at")
  @@map("expense_comment")
}
